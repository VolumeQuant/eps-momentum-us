# EPS Momentum System v22 - Revenue Required (US Stocks)

Forward 12개월 EPS(NTM EPS) 기반 모멘텀 시스템. "파괴적 혁신 기업을 싸게 살래" 철학으로, EPS 괴리율(70%)과 매출 성장률(30%)을 복합 점수화하여 종목을 선별. MA60 + 3일 연속 검증으로 신뢰도를 높이고, AI(Gemini)가 위험 신호를 점검한 뒤 최종 포트폴리오를 추천.

## 핵심 전략

### NTM (Next Twelve Months) EPS
yfinance의 0y/+1y EPS를 **endDate 기반 시간 가중치**로 블렌딩하여 Forward 12개월 EPS를 산출.
기존 +1y 컬럼은 종목마다 가리키는 연도가 달라 비교가 불가능했으나, NTM으로 통일.

### 매수 후보 선정 (Composite Score 기반)

**철학**: adj_gap(저평가) 70% + 매출 성장률 30%의 복합 점수로 정렬. 혁신 없는 종목은 저평가여도 제외.

**필터 (7개)**:
| 필터 | 조건 | 근거 |
|------|------|------|
| EPS 모멘텀 | adj_score > 9 | 방향 보정 점수 최소 기준 |
| EPS 개선 | eps_change_90d > 0 | EPS가 실제로 올라야 함 |
| Fwd PE 유효 | fwd_pe > 0 | 데이터 유효성 |
| **MA60** | price > 60일 이동평균 | 하락 추세 종목 제외 (기술적 안전장치) |
| **$10** | price ≥ $10 | 페니스톡 제외 |
| **매출 성장** | rev_growth ≥ 10% | 혁신 부족 기업 제외 (HSY, LUV, F 등 탈락) |
| **턴어라운드** | \|NTM\| ≥ $1.00 | 저 베이스 EPS 왜곡 방지 |

**Composite Score 정렬**:
```
z_gap = z-score(adj_gap)     # 부호 반전: 음수가 좋으므로 -z_gap
z_rev = z-score(rev_growth)  # 양수가 좋음

composite = (-z_gap) * 0.7 + z_rev * 0.3
```
- adj_gap: EPS 개선 대비 주가 미반영도 (70%)
- rev_growth: yfinance `revenueGrowth` (30%)
- rev_growth 없는 종목: composite 정렬 뒤에 adj_gap 순으로 붙임
- `fetch_revenue_growth()`: eligible 상위 50종목만 수집 (~12초)

### 3일 연속 검증 + ⏳ 2일 관찰
- Top 30 종목에 `part2_rank` 부여 → DB 저장
- 최근 3일 모두 Top 30 = ✅ (포트폴리오 대상)
- 최근 2일 연속 Top 30 = ⏳ (표시만, 내일 검증 가능)
- 그 외 = 🆕 (오늘 첫 진입)
- 포트폴리오는 ✅ 종목에서만 선정

### 매도 기준: "목록에 있으면 보유, 없으면 매도 검토"
- Top 30 = 보유 목록. 복잡한 Death List 로직 없음
- 어제 대비 이탈 종목을 [1/3] 메시지 하단에 간단히 표시
- `get_daily_changes()`: 어제 Top 30 vs 오늘 Top 30 단순 set 비교
- 최소 2주 보유 권장 (이익 전망 → 주가 반영 사이클)

### EPS 점수: Score → adj_score (방향 보정)
**기본 Score** = seg1 + seg2 + seg3 + seg4
90일을 4개 독립 구간으로 나눠 각 구간 변화율 합산 (세그먼트 캡: ±100%).
```
|----seg4----|----seg3----|----seg2----|--seg1--|
90d         60d         30d          7d      today
```

**방향 보정 (adj_score)**:
```
recent = (seg1 + seg2) / 2
old = (seg3 + seg4) / 2
direction = recent - old
adj_score = score × (1 + clamp(direction / 30, -0.3, +0.3))
```
- Part 2 진입 필터(adj_score > 9)에 사용

### 괴리율: fwd_pe_chg → adj_gap (방향 보정)
**기본 fwd_pe_chg** = 가중평균 Fwd P/E 변화율 (7d×40% + 30d×30% + 60d×20% + 90d×10%)
각 시점의 Fwd PE(= 주가/NTM EPS)를 비교. 음수 = EPS 개선 대비 주가 미반영 (저평가).

**방향 보정 (adj_gap)**:
```
adj_gap = fwd_pe_chg × (1 + clamp(direction / 30, -0.3, +0.3))
```
- 가속 EPS(direction > 0) → 저평가 강화 (더 음수)
- 감속 EPS(direction < 0) → 저평가 약화 (덜 음수)
- Composite Score의 70% 가중치로 사용

### 추세 표시: 5단계 아이콘 + 12패턴
4개 세그먼트의 방향과 크기를 아이콘으로 시각화 (순서: 과거→현재):
- 🔥 폭등 (>20%) — 폭발적 상승
- ☀️ 강세 (5~20%)
- 🌤️ 상승 (1~5%)
- ☁️ 보합 (±1%)
- 🌧️ 하락 (<-1%)

🔥가 있으면 해당 구간에서 폭등이 발생했다는 것을 즉시 파악 가능.
12개 기본 패턴(횡보/하락/전구간 상승/꾸준한 상승/상향 가속/최근 급상향/중반 강세/상승 등락/상향 둔화/반등/추세 전환/등락 반복)에 🔥 강도 수식어(폭발적~/급~/중반 급등/폭발적 등락/급등 후 둔화 등) 조합.

### 의견 (EPS Revision Breadth)
30일간 EPS 상향/하향 수정 애널리스트 수 표시: `의견 ↑N ↓N`
yfinance `epsRevisions.upLast30days/downLast30days` — **max(0y, +1y)** 데이터 사용. NTM 블렌딩에 맞춰 양쪽 기간 반영.

### ⚠️ 경고 시스템
주가 하락이 EPS 개선 대비 과도한 종목 감지:
- 조건: EPS 가중평균 > 0, 주가 가중평균 < 0, |주가변화| / |EPS변화| > 5
- ⚠️ 아이콘 표시 (텍스트 없이 아이콘만)

### 리스크 필터 (포트폴리오 & AI 리스크 필터 공통)
시스템 철학: adj_gap = 저평가 기회. 필터는 **데이터 자체의 신뢰성**만 검증하고, 주가/밸류에이션은 건드리지 않음.
| 플래그 | 조건 | 근거 |
|--------|------|------|
| 하향 | rev_down/(up+down) > 30% | 다수 애널리스트 동시 하향 → EPS 전망 신뢰 하락 |
| 저커버리지 | num_analysts < 3 | 소수 의견 → NTM EPS 데이터 불안정 |
| 어닝 | 2주 이내 실적발표 | **표시만** (포트폴리오 제외 안 함). EPS 상향 중이면 오히려 기회 |

`rev_up`, `rev_down`, `num_analysts`는 **max(0y, +1y)** — NTM 블렌딩에 맞춰 양쪽 기간 반영.

### 턴어라운드 (내부 처리)
`abs(NTM_current) < $1.00` 또는 `abs(NTM_90d) < $1.00`인 종목은 내부적으로 분리.
저 베이스 EPS로 인한 Score 왜곡 방지 목적. 별도 메시지로 발송하지 않음.

### AI 리스크 필터 (Gemini 2.5 Flash)
"검색은 코드가, 분석은 AI가" — yfinance로 팩트 수집, AI는 데이터 해석에 집중.
- **📰 시장 동향** (필수): 어제 미국 시장 마감 + 금주 주요 이벤트 (Google Search 1회)
- **⚠️ 매수 주의**: 위험 신호 기반 주의 종목 (없으면 "✅ 양호")
- **📅 어닝 주의**: yfinance `stock.calendar`에서 2주내 실적발표 직접 조회 (AI 비의존)
- 인사말/서두/맺음말 금지 → 3개 섹션만 출력
- 응답 검증: 📰 또는 "시장" 키워드 없으면 자동 재시도
- `[SEP]` 마커 → 빈 줄(`\n\n`) 변환
- 데이터에 있는 정보만 사용, 없는 내용 생성 금지, temperature 0.2

## 유니버스

NASDAQ 100 + S&P 500 + S&P 400 MidCap = **916개 종목** (중복 제거)

## 텔레그램 메시지

현재 **개인봇만 발송** (채널 전송 중단).

| 메시지 | 내용 |
|--------|------|
| 📖 투자 가이드 | 시스템 개요 (월가, 이익, 5단계 퍼널), 최소 2주 보유, 매도 기준 |
| [1/4] 📊 시장 현황 | 시장지수 + 신용시장(HY Spread) + 주도 업종 |
| [2/4] 📋 매수 후보 | Top 30(✅/⏳/🆕) + 📉 이탈 |
| [3/4] 🛡️ AI 리스크 필터 | 📰시장동향 + ⚠️주의종목 + 📅어닝 |
| [4/4] 🎯 최종 추천 | 퍼널 요약 + 동일 비중 포트폴리오 |
| 시스템 로그 | DB 적재 결과, 분포 통계 (개인봇) |

발송 순서: 📖 투자 가이드 → [1/4] 시장 → [2/4] 매수 후보 → [3/4] AI 필터 → [4/4] 최종 추천 → 시스템 로그

스토리 라인: 📖이해 → 📊시장 → 📋탐색 → 🛡️필터링 → 🎯실행.
핵심 원칙: **목록에 있으면 보유, 없으면 매도 검토.** 빅맥처럼 단순 명료하게.

### 메시지 포맷 (4줄 레이아웃)
```
✅ 1. 종목명(티커)
업종 · 날씨아이콘 추세설명
EPS +N% · 매출 +N%
의견 ↑N↓N · 순위 3→4→1
```
- 순위 이력: `get_rank_history()` → 최근 3일 DB 조회 → `3→4→1`
- 이력 없으면 `-→-→N` 형태
- 이탈 종목: `종목명(티커) · 어제 N위 → M위/조건 미달`

### 업종 분포 통계
[1/3] 메시지에 Top 30의 업종 분포를 표시: `📊 주도 업종: 반도체 8 · 통신장비 3`
2종목 이상 업종만 표시. 주도 섹터 파악, 시장 폭(Market Breadth) 판단, 섹터 로테이션 감지 용도.

### 포트폴리오 추천
매수 후보 중 ✅ (3일 검증) + 리스크 필터 통과 종목 → composite 순서 그대로 상위 5개 선정 (섹터 분산 없음).
**동일 비중**: 5종목 각 20% (3종목이면 34/33/33). Gemini가 종목별 선정 이유 생성.
✅ 종목 부족 시 있는 만큼만 추천. 0개면 "관망 권장" 메시지.

### 시장 컨텍스트
[1/3] 메시지 상단에 S&P 500 / 나스닥 전일 종가 및 등락률 표시.
yfinance `^GSPC`, `^IXIC` 5일 히스토리에서 계산.

### 신용시장 모니터링 (HY Spread)
FRED BAMLH0A0HYM2 (US High Yield Spread) 기반 Verdad 4분면 모델.
[1/3] 메시지에 시장지수 아래 표시, 현금비중 자동 조절 (0~70%).

| 분면 | 현금 | 행동 가이드 |
|------|------|------------|
| Q1 회복기 | 0% | 적극 매수하세요. 역사적으로 수익률이 가장 높은 구간이에요. |
| Q2 성장기 | 20% | 평소대로 투자하세요. |
| Q3 과열기 | 20~30% | 매수할 때 신중하게 / 신규 매수를 줄여가세요. |
| Q4 침체기 | 30~70% | 매수 멈추고 → 비중 축소 → 현금 확보 (단계적) |

해빙 신호 4종 (적극 매수 기회): HY 급락, 5% 하향돌파, 60일 고점 대비 -300bp, Q4→Q1 전환.

### VIX 지수 분석 (Layer 2 도입 예정)

두 에이전트(한국 전략 + US 전략)가 독립적으로 VIX 35년(1990~2025) 데이터를 분석하여 동일한 결론에 도달.

#### 핵심 발견

**1. VIX 기초 통계**: 평균 19.71, 중앙값 17.84, 최저 9.14(2017), 최고 82.69(2020 코로나). 우편향 분포 — 평소 낮은 수준, 간헐적 극단 스파이크.

**2. Mean-Reversion (평균회귀)**: VIX는 금융 지표 중 가장 강력한 평균회귀 특성. Half-life 2~10일(평상시). 스파이크가 클수록 회귀 속도가 빠름. 단, 구조적 위기(2008, 2020)에서는 수개월 고착 가능 → HY 교차 확인 필수.

**3. VIX 레벨별 향후 수익률** (Hartford Funds, WisdomTree, BlackRock 실증):

| VIX 레벨 | 6개월 후 | 12개월 후 |
|----------|---------|----------|
| <15 (저변동) | +3~5% | +5~8% |
| 15~20 (보통) | +4~6% | +8~12% |
| 20~30 (고변동) | +5~10% | +10~18% |
| **30+ (극단)** | **+13.4%** | **+23.4%** |

VIX 30+ 이후 6개월 후 85% 확률 상승, 12개월 후 90% 확률 상승. VIX 40+ 도달 후 3년 이내 **예외 없이** 시장 회복.

**4. HY와 VIX의 상호보완성**: 상관계수 +0.71 (일별). VIX가 HY 분산의 51%만 설명 → 나머지 49%는 독립 정보.

| 상황 | VIX 반응 | HY 반응 |
|------|----------|---------|
| 급락장 초기 (1~3일) | 즉시 +50~100% 스파이크 | 1~3일 지연 |
| 신용 위기 서서히 확대 | 반응 미미 | 수주~수개월 점진 상승 |
| Flash crash | 극단적 스파이크 | 거의 무반응 |

→ **HY = 방향타 (구조적 방향), VIX = 속도계 (순간적 변동성)**

**5. VIX Term Structure**: VIX/VIX3M 비율 >1.0(백워데이션) = 단기 공포 극심. 백워데이션에서 정상(콘탱고)으로 복귀하는 시점 = 바닥 확인의 가장 신뢰도 높은 신호 (COVID 바닥 2020.04 일치).

**6. VVIX (2차 미분)**: VIX의 변동성. 120+ 도달 후 하락 전환 = VIX 정점 신호.

#### 추천 전략: Strategy C — HY + VIX 복합 3레이어 모델

```
Layer 1: HY Quadrant (기존) → base_cash = Q1:0% Q2:20% Q3:30% Q4:30~70%
Layer 2: VIX Adjustment (신규) → vix_adj = VIX 상태에 따른 가감
Layer 3: Concordance Check (신규) → 두 지표 일치/불일치에 따른 확신도
final_cash = clamp(base + vix_adj + conc_adj, 0, 80)
```

**Layer 2: VIX 가감 규칙**:

| VIX 조건 | 가감 | 이유 |
|----------|------|------|
| VIX > 35, 기울기 상승 | +15% | 위기 모드 |
| VIX 25~35, 기울기 상승 | +10% | 상승 경계 |
| VIX 20~25, 기울기 상승 | +5% | 경미한 경계 |
| VIX < 12 | +5% | Complacency 경고 |
| **VIX > 35, 기울기 하락** | **-10%** | **공포 해소 = 매수 기회** |
| VIX 20~25, 기울기 하락 | -5% | 안정화 중 |

**Layer 3: Concordance (일치성) 규칙**:

| HY 방향 | VIX 방향 | 가감 | 해석 |
|---------|---------|------|------|
| 악화 | 악화 | +10% | 동시 경고 — 2008, 2020 초기 패턴 |
| 개선 | 개선 | -5% | 동시 안정 — 최적 투자 구간 |
| 악화 | 안정 | 0% | HY 신용 리스크 우선 |
| 개선 | 악화 | +5% | 단기 쇼크 대비 |

**VIX 40+ 역설**: 극단적 공포 구간에서 VIX가 하락 전환하면 역사적 최고 매수 기회. Q1(회복) + VIX 하락 = 12개월 평균 +23.4%. 단, 하락 전환 전까지는 추가 급락 가능 → 분할 매수 원칙 병행.

**데이터 소스**: FRED `VIXCLS` (CBOE VIX 일별, 1990~), `VXVCLS` (VIX3M, 2007.12~). 기존 `fetch_hy_quadrant()`의 FRED CSV 패턴 그대로 사용 가능.

**백테스트 규칙 8개**:

| # | 조건 | 행동 | 근거 |
|---|------|------|------|
| V1 | VIX > 30, 5일Δ > 10 | 현금 +15~20% | 급등 지속 = 방어 |
| V2 | VIX > 40, 5일Δ < 0 | 현금 -15~20% | 패닉 후 회복 = 매수 기회 |
| V3 | VIX < 15 20일 연속 | 현금 -5% | 안정 구간 |
| V4 | VIX/VIX3M > 1.0 | 현금 +10% | 백워데이션 = 단기 공포 |
| V5 | HY Q4 + VIX 30+ | 현금 = 70% | 이중 위험 |
| V6 | HY Q1 + VIX 하락 | 현금 = 0% | 이중 안전 |
| V7 | HY Q4 + VIX 급락(-10pt/5d) | 현금 40% | VIX 선행 회복 |
| V8 | 일변화 > 5pt | 당일 긴급 +10% | 일일 급등 방어 |

**구현 우선순위**: ① FRED VIXCLS 수집 → ② VIX Layer 2 통합 → ③ 텔레그램 VIX 표시 → ④ VIX3M term structure → ⑤ 백테스트

## DB 스키마

```sql
CREATE TABLE ntm_screening (
    date TEXT, ticker TEXT, rank INTEGER, score REAL,
    ntm_current REAL, ntm_7d REAL, ntm_30d REAL, ntm_60d REAL, ntm_90d REAL,
    is_turnaround INTEGER DEFAULT 0,
    adj_score REAL, adj_gap REAL,
    price REAL, ma60 REAL,
    part2_rank INTEGER,
    PRIMARY KEY (date, ticker)
);
```

전 종목 매일 저장 (`INSERT ... ON CONFLICT DO UPDATE` — 재수집 시 part2_rank 보존).
`save_part2_ranks()`: 저장 전 기존 rank 전부 NULL 초기화 → 잔여 rank 방지.

## 실행

```bash
# 로컬 실행
python daily_runner.py

# GitHub Actions
# KST 07:15 자동 실행 (cron: '15 22 * * 0-4' UTC)
```

### 마켓 날짜 자동 감지
- SPY 최근 거래일 기준으로 `today_str` 결정 (`yf.Ticker("SPY").history(period="5d")`)
- `MARKET_DATE` 환경변수로 오버라이드 가능
- EST 자정 이후 테스트 실행 시 미래 날짜 저장 방지

### 영업일/휴장 처리
- 3일 교집합은 **DB에 있는 distinct date** 기준 → 주말/공휴일 별도 처리 불필요
- 미국 공휴일은 yfinance 데이터 부재로 자연스럽게 skip

### Cold Start 자동 전환
- DB에 `part2_rank` 데이터가 3일 미만 → **개인봇만** 전송 (채널 비활성화)
- 3일 이상 축적되면 자동 전환
- 날짜 하드코딩 없이 DB 상태 기반 자동 판단 (`is_cold_start()`)
- Cold start 시 전부 🆕 처리 (검증 없이 ✅ 부여하지 않음)

### 환경변수 (GitHub Secrets)
- `TELEGRAM_BOT_TOKEN`: 텔레그램 봇 토큰
- `TELEGRAM_CHAT_ID`: 채널 ID (현재 비활성)
- `TELEGRAM_PRIVATE_ID`: 개인봇 ID
- `GEMINI_API_KEY`: Google AI Studio API 키

## 파일 구조

```
eps_momentum_system.py    # INDICES, INDUSTRY_MAP, NTM 계산 함수, get_trend_lights()
daily_runner.py           # 데이터 수집, MA60, 3일 검증, AI 분석, 텔레그램, main()
config.json               # 텔레그램 토큰, Gemini API 키, Git 설정 (.gitignore)
run_daily.bat             # Windows 로컬 실행 스크립트
requirements.txt          # Python 패키지 의존성
ticker_info_cache.json    # 종목 이름/업종 캐시 (자동 생성)
eps_momentum_data.db      # SQLite DB (자동 생성)
backtest.py               # 백테스트 프레임워크 (검증일수 × 보유기간 매트릭스)
SESSION_HANDOFF.md        # 설계 결정 히스토리 (v1~v21)
```

## 버전 히스토리

| 버전 | 날짜 | 변경 |
|------|------|------|
| **v22** | **2026-02-12** | **Revenue Required**: 섹터 분산 제거(composite 순서 그대로), rev_growth 필수화(매출 데이터 없으면 Top 30 제외), 매출 수집 전체 확대(50→eligible 전체), 업종 분포 통계 추가 |
| v21 | 2026-02-12 | Composite Score: adj_gap 70%+매출성장률 30% 복합 순위, 매출 10% 하드 필터, 동일 비중(각 20%), AI 프롬프트 구조화(3섹션+검증), 채널 전송 중단, 메시지 4줄 포맷, 순위 이력 3일 표시 |
| v20 | 2026-02-11 | Simple & Clear: Death List 제거→set 비교, Top 30 통일, ⏳ 표시 전용, 투자 가이드 재작성, 메시지 3개 분리, adj_gap≤0 필터 제거, 마켓 날짜 자동 감지, ON CONFLICT 보존, 섹터 분산, 리스크 필터 철학 확립(하향 비율 30%, 고평가 제거, 어닝 소프트) |
| v19.2 | 2026-02-10 | UI 개선: [1/2][2/2] 구조, 시장 컨텍스트, MAX_WEIGHT 30%, 날짜 biz_day 통일 |
| v19 | 2026-02-10 | Safety & Trend Fusion: MA60+3일검증+Death List, Part 1 제거, 메시지 3개 축소, cron 22:15 |
| v18 | 2026-02-09 | adj_gap 도입, 리스크 필터 정비 (모순 제거 + 저커버리지 추가) |
| v15 | 2026-02-09 | 날씨 아이콘 전환 (6단계 신호등→5단계 날씨), 정량 리스크 스캐너, 포트폴리오 추천 |
| v14 | 2026-02-08 | AI 브리핑 전환: 뉴스 스캐너→데이터 분석, 어닝 yfinance 직접 조회 |
| v11~13 | 2026-02-08 | 방향 보정(adj_score), 트래픽 라이트 12패턴 확장 |
| v8~10 | 2026-02-07~08 | Gemini AI 리스크 검증, 소거법 전환, NTM EPS 전환 |
| v1~7 | 2026-01~02 | 초기 구현, A/B 테스팅, 기술적 필터, Value-Momentum Hybrid |
