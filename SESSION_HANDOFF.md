# SESSION_HANDOFF.md
## EPS Momentum System v7.2.3 - 장중 데이터 필터링 추가

**Last Updated:** 2026-02-06 00:10
**Session:** v7.2.3 완성 - 장중/장마감 데이터 구분 로직 추가

---

## 1. v7.2.3 주요 변경사항 (2026-02-06)

### A. 장중 데이터 필터링 (핵심 버그 수정)
- **문제**: 장중 실행시 실시간 가격이 반영되어 등락률 오류
- **해결**: 미국 동부시간 16시(장마감) 기준으로 데이터 필터링
  - 16시 이전 (장중): 오늘 데이터 제외 → 전일 마감가 사용
  - 16시 이후 (장마감): 오늘 데이터 포함 → 당일 마감가 사용

```python
market_closed = now_us.hour >= 16  # 16시 이후 = 장 마감
if not market_closed:
    hist_1m = hist_1m[hist_1m.index.date < today_us]
```

---

## 2. v7.2.2 주요 변경사항 (2026-02-05)

### A. Option A 적용 - 순위 = 매수 우선순위
- **이전**: 24개 통과 종목 전체 순위 표시 (RSI 과열 종목 포함)
- **현재**: 매수 가능 종목만 표시 (RSI < 70 + 매수 액션)
- 순위 1위 = 가장 먼저 매수해야 할 종목

### B. 메시지 통합 (2-3개 → 1-2개)
| 메시지 | 내용 |
|--------|------|
| 1 | 시장현황 + 스크리닝 결과 + TOP 10 상세 |
| 2 | 11위 이후 (있으면) |
| Admin | 시스템 로그 (봇만) |

### C. 섹터 분석 제거
- 고객에게 불필요한 정보로 판단
- 메시지 간결화

### D. 선정이유 간소화
- **이전**: 불릿 포인트 2개, 밸류 점수 언급
- **현재**: 한 줄로 표시 (매출/영업익 성장, ROE)
- 예: `📝 매출 +22%, 영업익 +36% / ROE 66% (초고수익)`

### E. 불필요한 정보 제거
- 밸류 점수 (고객이 몇점인지 몰라도 됨)
- 리스크 섹션 (룰베이스로 의미 없음)
- "전일종가" 라벨 → "$가격"만 표시

---

## 2. v7.2.0 주요 변경사항 (2026-02-05)

### A. GitHub Actions 자동화
- **스케줄**: UTC 23:00 = KST 08:00 (월~금)
- **워크플로우**: `.github/workflows/daily-screening.yml`
- **환경변수**: `TELEGRAM_BOT_TOKEN`, `TELEGRAM_CHAT_ID`, `TELEGRAM_PRIVATE_ID`
- **권한**: `permissions: contents: write` (git push용)

### B. 텔레그램 전송 분리
| 환경 | User 메시지 (TOP10, 11-26위) | Admin 메시지 |
|------|------------------------------|--------------|
| 로컬 | 봇(개인)만 | 봇만 |
| GitHub Actions | 채널 + 봇 | 봇만 |

### C. 날짜 표시 로직
- **인사말**: 한국 날짜 (예: "오늘(02월06일)")
- **시장 데이터**: 미국 최근 영업일 (예: "2026년 02월 05일 (미국장 기준)")
- `get_display_dates()` 함수로 타임존 처리 (pytz)

### D. 섹터 분석 개선
- **이전**: `industry` 세부 분류 (20개+)
- **현재**: `sector` 대분류 (7개 GICS)
- Healthcare, Consumer Cyclical, Technology, Semiconductor 등

### E. 메시지 간소화
- "11-26위 중 주목" 섹션 제거 (과매도, 방어주 등)
- 불필요한 정보 삭제로 메시지 단순화

### F. Admin 메시지 개선
- 버전 표기: v6.3 → v7.2 업데이트
- **데이터 누적 기간 표시**: "2026-01-31 ~ 2026-02-05 (4일)" 형식
- DB 크기 + 누적 기간 함께 표시

---

## 2. 점수 체계 (v7.1)
```python
# v7.2: 총점 = 밸류 (EPS 모멘텀)
total_score = quality_score
# 진입 타이밍은 액션 분류로 판단 (RSI, 지지선, 거래량)
```

### 밸류 Score (Quality, 100점)
EPS 모멘텀 기간별 가중치 - 최근일수록 높음:

| 기간 | 배점 | 계산 |
|------|------|------|
| 7일 | 24점 | `min(24, eps_chg_7d * 2.4)` |
| 30일 | 22점 | `min(22, eps_chg_30d * 0.73)` |
| 60일 | 18점 | `min(18, eps_chg_60d * 0.3)` |
| 90일 | 16점 | `min(16, eps_chg_90d * 0.16)` |
| 정배열 | 20점 | C > 7d > 30d > 60d |

### 가격 Score (Value, 100점)

| 항목 | 배점 | 기준 |
|------|------|------|
| RSI 점수 | 40점 | 낮을수록 좋음 (30↓:40점) |
| 52주 위치 | 30점 | 고점 대비 하락 폭 |
| 거래량 | 20점 | 20일 평균 대비 |
| 기본 점수 | 10점 | 통과 종목 기본 |

---

## 3. v7.1.x 변경사항

**1. 핵심추천 삭제** - 순위 = 매수 우선순위
- "1위인데 돌파확인" 같은 혼란 제거
- 순위가 높을수록 먼저 매수

**2. 신고가 돌파 점수 조정**
- 이전: 신고가 돌파시 가격 80점+ (보너스)
- 현재: 감점만 안 함 (보너스 없음, 비싸면 비싼 것)

**3. 섹터 분석 추가**
- 한글+영문 섹터명
- ETF 추천 (SMH/SOXL, XBI/LABU 등)
- 주도섹터: 1위 > 2위일 때만 표시

**4. 뉴스 기능 제거 (v7.1.6)**
- 번역 품질 이슈로 제거
- 자동화 안정성 우선

---

## 2. 텔레그램 메시지 포맷 v7.2.2

### 통합 메시지 예시
```
안녕하세요! 오늘(02월05일) 미국주식 EPS 모멘텀 포트폴리오입니다 📊

━━━━━━━━━━━━━━━━━━━
          📈 시장 현황
━━━━━━━━━━━━━━━━━━━
📅 2026년 02월 04일 (미국장 기준)
🟡 경계 (YELLOW)

• 나스닥 21,500 (-1.2%) ⚠️MA50↓
• S&P500 6,000 (-0.8%)
• VIX 16.5 (안정)

━━━━━━━━━━━━━━━━━━━
          📋 스크리닝 결과
━━━━━━━━━━━━━━━━━━━
917개 스캔 → 24개 통과 → 5개 매수 가능

━━━━━━━━━━━━━━━━━━━
    🏆 매수 종목 TOP 5
━━━━━━━━━━━━━━━━━━━

🥇 1위 Lam Research Corporation (LRCX) 반도체
💰 $209.78 (-8.83%)
📈 적극매수 (눌림목)
📝 매출 +22%, 영업익 +36% / ROE 66% (초고수익)

🥈 2위 Newmont Corporation (NEM) 소재
💰 $116.85 (-0.25%)
📈 적극매수 (눌림목)
📝 매출 +20%, 영업익 +102% / EPS 추정치 상향 지속
...
```

### 종목 표시 형식 (간소화)
```
{순위아이콘} {순위}위 {회사명} ({티커}) {섹터}
💰 ${가격} ({등락률})
📈 {진입액션}
📝 {선정이유 한 줄}
```

---

## 3. 수정된 파일 (v7.1.6)

### daily_runner.py
- `generate_rationale_bullets_v71()` - 선정이유 불릿 포인트 자동 생성
- `generate_risk_v71()` - 리스크 자동 생성
- `create_telegram_message_v71()` - v7.1.6 메시지 생성기
- 섹터 분석 (한글+영문+ETF) 추가
- 핵심추천 섹션 삭제
- 뉴스 기능 완전 제거

### eps_momentum_system.py
- `calculate_quality_score_v71()` - 밸류 Score
- `calculate_value_score_v71()` - 가격 Score
- 신고가 돌파 점수 조정 (보너스 제거)

### README.md, DOCUMENTATION.md
- v7.1.6 변경사항 반영
- 섹터 분석 설명 추가
- 신고가 돌파 로직 업데이트

---

## 4. 버전 히스토리

| 버전 | 변경사항 |
|------|----------|
| **v7.2.3** | 장중 데이터 필터링 - 16시(EST) 기준 장마감 여부 판단, 전일/당일 마감가 구분 |
| v7.2.2 | Option A 적용 (매수 가능만 표시), 메시지 1개 통합, 섹터 분석/리스크 제거, 선정이유 간소화 |
| v7.2.1 | 메시지 개편 - 시장 등락률, 전략 상세설명, "오늘의 매수 기회" 요약 |
| v7.2.0 | GitHub Actions 자동화, 텔레그램 채널/봇 분리, 섹터 대분류, 날짜 로직 개선 |
| v7.1.8 | 리스크 문구 개선 (밸류/가격 약점 + 구체적 섹터 설명) |
| v7.1.7 | 섹터별 리스크 사전 확대 (12개 GICS 섹터) |
| v7.1.6 | 뉴스 기능 완전 제거 (자동화 안정성) |
| v7.1.2 | 섹터 분석을 TOP 10 앞으로 이동 |
| v7.1.1 | 신고가 RSI 조정, 핵심추천 삭제, 섹터 분석 |
| v7.1 | 밸류+가격 100점 체계, 텔레그램 완전 자동화 |

---

## 5. 실행 방법

```bash
# 전략 실행 (volumequant Python 사용)
"C:/Users/jkw88/miniconda3/envs/volumequant/python.exe" "C:/dev/claude-code/eps-momentum-us/daily_runner.py"
```

**자동화 흐름:**
1. 시장 국면 체크 (RED/YELLOW/GREEN)
2. 917개 종목 스크리닝 → N개 통과
3. 섹터 분석 + ETF 추천
4. TOP 10 + 11-26위 메시지 생성
5. 텔레그램 전송 (2개 메시지)
6. Git commit/push

---

## 6. 다음 작업

- [x] 점수 체계 개편 (밸류+가격 100점) ✅
- [x] 핵심추천 삭제 (순위 = 우선순위) ✅
- [x] 신고가 돌파 점수 조정 ✅
- [x] 섹터 분석 (한글+영문+ETF) ✅ → 제거됨 (v7.2.2)
- [x] 뉴스 기능 제거 ✅
- [x] GitHub Actions 자동화 ✅
- [x] 텔레그램 채널/봇 분리 ✅
- [x] 문서 업데이트 ✅
- [x] Option A 적용 (매수 가능 종목만 표시) ✅
- [x] 메시지 1개로 통합 ✅
- [x] 섹터 분석 제거 ✅
- [x] 리스크 섹션 제거 ✅
- [ ] GREEN 모드 테스트

---

*작성: Claude Opus 4.5 | 2026-02-05*
