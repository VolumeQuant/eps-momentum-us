# Session Handoff: 전략 개선 논의

> **v1**: 2026-02-06 직장 PC — 구조적 문제 발견, score_321 개선 논의
> **v2**: 2026-02-06 집 PC — NTM EPS 전환 결정, DB/Score/랭킹 전면 재설계
> **v3**: 2026-02-06 집 PC — 풀 유니버스 시뮬레이션, 이상치 처리, Part 2 재설계
> **v4**: 2026-02-06 집 PC — 텔레그램 포맷 확정, 발송 채널 분리, 업종 매핑
> **v5**: 2026-02-07 집 PC — 모바일 UI 리디자인, 고객 친화적 말투
> **v6**: 2026-02-07 집 PC — 트래픽 라이트, ⚠️ 경고, Part 2 EPS>0 필터, 코드 정리
> **v7**: 2026-02-07 집 PC — 4단계 신호등, Score 정렬, 가중평균, MD 정리
> **v8**: 2026-02-07 집 PC — Gemini 2.5 Flash AI 리스크 검증 도입
> **v9**: 2026-02-08 집 PC — 6단계 트래픽 라이트, AI 뉴스 스캐너, 턴어라운드 메시지 제거, Score > 10, Part 2 표시값 변경
> **v10**: 2026-02-08 집 PC — AI 리스크 스캐너 소거법 전환, 프롬프트 5회 반복 튜닝
> **v11**: 2026-02-08 집 PC — 방향 보정(adj_score) 도입, Part 2 필터 adj_score > 9
> **v12**: 2026-02-08 집 PC — 트래픽 라이트 8패턴 리디자인, Part 2 괴리율+의견 표시 추가
> **v13**: 2026-02-08 집 PC — 트래픽 라이트 12패턴 확장 (피크 위치 기반 + 진동 감지, "상향 가속" 12/30→최대 5/30)
> **v14**: 2026-02-08 집 PC — AI 뉴스 스캐너→AI 브리핑 전환 (검색은 코드가, 분석은 AI가)
> **v15**: 2026-02-09 집 PC — AI 브리핑 정량 리스크 스캐너 전환, UI/말투 개선
> **v16**: 2026-02-09 집 PC — 포트폴리오 추천 기능 통합, Part 2 UI 압축
> **v17**: 2026-02-09 집 PC — adj_score 기반 정렬 전환, 메시지 단계별 흐름 [1/4]~[4/4], UI 개선

---

## Phase 1: 문제 발견 (직장 PC)

### 1-1. 시작점: "마이크로소프트는 왜 안 나오는 거야?"

텔레그램 메시지에서 MSFT를 한 번도 본 적 없다는 의문에서 시작.

### 1-2. Track 1 vs Track 2 필터 불일치

**Track 1 (텔레그램)**: 10단계 필터 → ~24개 통과
**Track 2 (DB)**: 2단계 필터 → ~265개 passed

MSFT는 EPS 모멘텀(score 9.5)은 좋지만, **Price < MA200**에서 Track 1 탈락.
→ "무엇을 보유할까"와 "언제 살까"가 같은 필터에 혼재된 구조적 문제.

### 1-3. score_321 공식의 문제

```python
# 기존 방식: binary 방향 + 임의 스케일링 + 90d 미사용
if current > d7:  score += 3    # 0.01% 올라도 +3, 10% 올라도 +3
score += eps_chg_60d / 5        # 임의 스케일링
# 90d는 아예 안 봄 → TTWO(90d -34%)를 못 잡음
```

---

## Phase 2: 근본적 재설계 (집 PC)

### 2-1. +1y 컬럼의 치명적 문제 발견

현재 시스템은 `trend.loc['+1y']`로 EPS를 가져오는데, **`+1y`가 가리키는 실제 연도가 종목마다 다름:**

| 종목 | +1y endDate | 0y endDate | 원인 |
|------|-----------|-----------|------|
| AMZN | **2027**-12-31 | 2026-12-31 | FY2025 발표 완료, 롤오버 |
| CRWV | **2026**-12-31 | 2025-12-31 | FY2025 미발표 |
| AAPL | **2027**-09-30 | 2026-09-30 | 9월 결산 |

**→ +1y끼리 비교하면 2026년과 2027년 EPS가 뒤섞인 엉터리 랭킹**

**확인 방법**: `stock._analysis._earnings_trend` 리스트의 각 항목에 `endDate` 필드 존재

### 2-2. 해결: NTM (Forward 12M) EPS 도입

**0y와 +1y를 endDate 기반 시간 가중치로 블렌딩:**

```python
# 각 시점(ref_date)마다 앞으로 12개월 윈도우를 계산
window_start = ref_date
window_end = ref_date + 365일

# 0y, +1y 각각의 겹치는 기간으로 가중치 산출
w0 = overlap(window, 0y_fiscal_year) / total_overlap
w1 = overlap(window, +1y_fiscal_year) / total_overlap

NTM_EPS = w0 × (0y EPS) + w1 × (+1y EPS)
```

**핵심: 5개 시점 각각 가중치를 재계산**
- NTM_current: 오늘 기준 가중치로 블렌딩
- NTM_7d: 7일 전 기준 가중치로 블렌딩
- NTM_30d: 30일 전 기준 가중치로 블렌딩
- NTM_60d: 60일 전 기준 가중치로 블렌딩
- NTM_90d: 90일 전 기준 가중치로 블렌딩

**검증 결과 (MSFT, 6월 결산):**
```
시점       0y(FY26)    w0      +1y(FY27)   w1      NTM EPS
current    17.202    39.6%  +  19.025    60.4%  =  18.304
7d ago     17.235    41.5%  +  18.997    58.5%  =  18.266
30d ago    15.678    47.8%  +  18.545    52.2%  =  17.175
60d ago    15.633    56.0%  +  18.531    44.0%  =  16.907
90d ago    15.661    64.3%  +  18.557    35.7%  =  16.696
```
- **NTM 모멘텀: +9.63%** (기존 +1y만: +2.52%) — 0y의 강한 상향이 반영됨

### 2-3. Score 공식 (NTM 기반, 내부 로직)

```python
seg1 = (NTM_current - NTM_7d)  / |NTM_7d|  × 100   # 최근 7일
seg2 = (NTM_7d - NTM_30d)     / |NTM_30d| × 100   # 7~30일 구간
seg3 = (NTM_30d - NTM_60d)    / |NTM_60d| × 100   # 30~60일 구간
seg4 = (NTM_60d - NTM_90d)    / |NTM_90d| × 100   # 60~90일 구간

score = seg1 + seg2 + seg3 + seg4
```

**4개 구간이 겹치지 않는 독립 구간으로 90일 전체를 커버:**
```
|----seg4----|----seg3----|----seg2----|--seg1--|
90d         60d         30d          7d      today
```

**참고**: v5까지는 내부용이었으나, v5 이후 Part 1의 정렬/표시 기준으로 변경됨. Part 2 필터(Score > 3)에도 사용.

### 2-4. 추세 표시 (트래픽 라이트)

seg 방향을 트래픽 라이트로 시각화. **순서: 과거→현재 (왼→오)**
```
추세(90d/60d/30d/7d)
    🟢  🟡  🔴  🟢
    seg4 seg3 seg2 seg1
```

**임계값 (v9 이후 6단계, 네모=강한 변동):**
- 🟩 폭발적 상승: > 20%
- 🟢 상승: 2~20%
- 🔵 양호: 0.5~2%
- 🟡 보합: 0~0.5%
- 🔴 하락: 0~-10%
- 🟥 급락: < -10%

**15개 말 설명 카테고리** (트래픽 라이트와 함께 표시):
| 패턴 | 말 설명 |
|------|---------|
| 🟢🟢🟢🟢 | 강세 지속 |
| 🟢🟢🟢🟡 | 소폭 감속 |
| 🟢🟢🟢🔴 | 최근 꺾임 |
| 🟢🟢🟡🟡 | 둔화 |
| 🔴🟢🟢🟢 | 반등 |
| 🔴🔴🟢🟢 | 가속 |
| 🟡🟡🟡🟡 | 거의 정체 |
| 🔴🔴🔴🔴 | 하락세 |
| 기타 (🟢 ≥ 3) | 소폭 개선 |
| 기타 (🔴 ≥ 3) | 최근 약세 |
| 기타 (상승세) | 회복 중, 변동 개선 등 |
| 기타 | 혼조, 등락 반복 등 |

**결정 근거 (v5):** 기존 ↑↓ 화살표는 방향만 표시. ▲△ 시도했으나 모바일에서 크기 다른 문제.
트래픽 라이트는 방향+속도를 동시에 표현하며 크기 일관됨. 말 설명 추가로 고객 이해도 향상.

---

## Phase 3: 시뮬레이션 & Part 2 재설계 (집 PC)

### 3-1. 유니버스 정리

- **현행 유지**: NASDAQ 100 + S&P 500 + S&P 400 MidCap = **915개**
- **FOX 제거**: FOX(Class B)는 eps_trend 데이터 없음, FOXA(Class A)가 커버 → `INDICES['SP500']`에서 제거 완료
- GOOG/GOOGL 둘 다 유지 (Class A/C 별도 상장)

### 3-2. 이상치 처리: |NTM EPS| < $1.00 분리

**문제 발견**: 1차 시뮬레이션에서 ALB 스코어 54,065 (NTM_90d ≈ $0.01 → 분모 폭발)

**검토한 대안들:**
| 방법 | 결과 | 문제점 |
|------|------|--------|
| 세그먼트 캡 (±200%) | ALB 800점 | 여전히 SNDK(322)보다 높음 — 부당 |
| 최소 분모 ($0.50) | ALB 521점 | 여전히 비정상적으로 높음 |
| Z-Score 정규화 | 분포 기반 | 1-2개 이상치가 전체 분포를 왜곡 |
| **|NTM| < $1.00 분리** ✅ | **깔끔하게 해결** | 없음 |

**최종 결정: $1.00 최소 EPS 기준**
- `abs(NTM_current) < $1.00` 또는 `abs(NTM_90d) < $1.00`이면 → **"턴어라운드" 카테고리**로 분리 (양 끝점만 체크, 중간 시점 이상치 방지)
- 메인 랭킹에서 제외, 별도 섹션으로 표시
- **근거**: NTM EPS가 $1 미만인 종목은 성장률 계산이 의미 없음 (0.01→0.02가 +100%)

### 3-3. 풀 유니버스 시뮬레이션 결과 (2026-02-06)

**기본 통계:**
```
전체 유니버스: 916개 (FOX 제거 전)
데이터 있음:   913개
데이터 없음:     0개
에러:            3개 (COKE, L, NEU — endDate 파싱 에러)
```

**$1 필터 적용 후:**
```
메인 랭킹:    861개 (|NTM| >= $1.00)
턴어라운드:    52개 (|NTM| < $1.00)
```

**Score 분포 (메인 861개):**
```
Score >  0:  596 (69%)
Score >  1:  506 (59%)
Score >  2:  389 (45%)
Score >  3:  310 (36%)
Score >  5:  177 (21%)
Score > 10:   74 (9%)
Score > 20:   31 (4%)
Min=-98.19, Max=322.15, Median=1.26
정배열: 236
```

### 3-4. Part 2: Forward P/E 변화율 (= 괴리율)

**기존 Part 2 (폐기):** MA200, RSI 기반 기술적 진입 타이밍
**새 Part 2:** EPS 개선이 아직 주가에 반영 안 된 종목 찾기

**핵심 지표: Forward P/E 90일 변화율 (고객 표시명: "괴리율")**
```python
Fwd_PE_now = Price_now / NTM_current
Fwd_PE_90d = Price_90d / NTM_90d
괴리율 = (Fwd_PE_now - Fwd_PE_90d) / Fwd_PE_90d × 100
```

**해석:**
- **괴리율 마이너스** = EPS 상향 > 주가 상승 → "아직 덜 반영됨" → **매수 기회**
- **괴리율 플러스** = 주가 상승 > EPS 상향 → "이미 선반영됨" → 추격 매수 위험

---

## Phase 4: 텔레그램 포맷 & 발송 채널 확정 ← NEW

### 4-1. Part 1 순위 기준 변경 (재변경: v5)

**v4 결정**: 90일 이익변화율 기준 정렬
**v5 재변경**: **Score 기준 정렬** (세그먼트 캡 ±100% 적용)

**v5 재변경 이유**: 시스템의 핵심이 4구간 Score인데 고객에게 다른 값을 보여주는 건 불일치.
Score가 높으면 꾸준하고 강하게 오르는 중이라는 의미를 읽는 법에서 설명.
세그먼트 캡(±100%)으로 이상치(ELS: 942→9.3) 방지.

### 4-2. 업종 분류

- yfinance의 `industry` 필드 사용 (130개 고유값)
- 한글 축약 매핑 테이블 1회 생성 (예: Semiconductors → 반도체, Software-Application → 응용SW)
- 매핑 안 된 건 영어 그대로 표시

### 4-3. 텔레그램 메시지 포맷 (v5~v6 모바일 최적화)

**설계 원칙:**
- 모바일 가로폭 우선 (테이블/고정폭 헤더 폐기)
- 3줄 레이아웃: rank+데이터 / 이름(티커) 업종 / 신호등+설명
- HTML bold/italic으로 시각적 구분, 종목 사이 빈 줄
- "읽는 법" 가이드를 데이터 목록 위에 배치
- 친절한 말투 + 수치 + 이해하기 쉬운 단어 ("~예요" 어체)

**Part 1: EPS 모멘텀 Top 30** (Score 순)
```
📈 EPS 모멘텀 Top 30
💡 읽는 법: Score, 4단계 신호등 설명

1위 · Score 225.6
Sandisk Corporation (SNDK) 반도체
🟢🟢🟢🟢 강세 지속
```

**Part 2: 매수 후보 Top 30** (Score > 3 필터, 괴리율 순)
```
💰 매수 후보 Top 30
💡 읽는 법: EPS/주가 가중평균, 신호등, ⚠️ 설명

1위 · EPS +5.2% · 주가 -12.3%
MicroStrategy (MSTR) 응용SW
🟢🟡🟢🔴 일시 조정
```

**턴어라운드 주목** (Top 10, Score 순)
```
⚡ 턴어라운드 주목
💡 읽는 법: 90일 전→현재 EPS 전망치, 예시 설명

1위 · EPS $0.24 → $2.61
Albemarle Corporation (ALB) 특수화학
🟢🟢🟢🟡 소폭 감속
```

### 4-4. 발송 채널

| 메시지 | 로컬 실행 | GitHub Actions |
|--------|----------|---------------|
| Part 1 (모멘텀 랭킹) | 개인봇 | **채널** |
| Part 2 (매수 후보) | 개인봇 | **채널** |
| 턴어라운드 | 개인봇 | **채널** |
| 시스템 로그 | 개인봇 | 개인봇 |

### 4-5. 실행 스케줄

- **GitHub Actions**: 매일 KST 07:30 (미국 장마감 ET 16:00 = KST 06:00, 데이터 안정화 후 1.5시간)
- **로컬**: 수동 실행 (개인봇에만 발송)

---

## 결정된 사항 ✅

1. **+1y → NTM EPS 전환**: endDate 기반 시간 가중 블렌딩
2. **Score = seg1+seg2+seg3+seg4**: 내부 DB 저장/필터링용
3. **Part 1 고객 표시는 Score**: 세그먼트 캡 ±100% 적용 (v5에서 변경)
4. **Part 1 정렬: Score 순** (v5에서 90일 이익변화율→Score로 재변경)
5. **Part 2 정렬: 괴리율 순** (Fwd P/E 90일 변화율)
6. **Part 2 필터: Score > 10** (상위 10% EPS 모멘텀, v9에서 3→10으로 상향)
7. **DB는 전 종목 저장**: 915개 전체 (나중에 순위 진입/이탈 추적 가능)
8. **패턴은 별도 저장 불필요**: 5개 NTM 값에서 재계산
9. **턴어라운드 분리**: `abs(current) < $1.00 OR abs(90d) < $1.00` → 양 끝점만 체크 (중간 시점 이상치 방지)
10. **FOX 제거**: eps_trend 없음, FOXA가 커버
11. **Fwd PE / 괴리율은 DB 미저장**: NTM 값 + Yahoo 주가에서 파생 가능
12. **업종: yfinance industry** → 한글 축약 매핑
13. **종목 표기: 이름(티커)** (v5에서 변경)
14. **추세: 6단계 트래픽 라이트 🟩🟢🔵🟡🔴🟥** — 네모=강한 변동, 순서 = 과거→현재, Score 기반 15개 말 설명 동반 (v9)
15. **Part 1: Top 30, GitHub Actions시 채널 발송** (로컬은 개인봇)
16. **Part 2: Top 30, GitHub Actions시 채널 발송, EPS 변화 > 0 필터 적용**
17. **턴어라운드: 내부 분리만, 메시지 발송 안 함** (v9에서 제거 — 대부분 저 베이스 왜곡, 진짜 턴어라운드 극소수)
18. **시스템 로그: 개인봇에만 발송** (DB 적재 컬럼명 포함)
19. **실행 스케줄: KST 07:30 GitHub Actions**
20. **에러 종목: skip** (로그만 남김)
21. **기존 eps_snapshots 테이블: 삭제**
22. **모바일 UI 리디자인 (v5)**: 테이블/고정폭 헤더 폐기, 한 줄/두 줄 compact 포맷, 고객 친화적 부제
23. **6단계 트래픽 라이트 (v5→v9)**: ↑↓→4단계→6단계. 네모(🟩🟥)=강한 변동, 동그라미=일반
24. **⚠️ 경고 시스템 (v6)**: Part 2에서 |주가변화|/|이익변화| > 5일 때 표시, 하드 필터 아닌 소프트 경고
25. **Part 2 EPS>0 필터 (v6)**: 이익 변화율 음수 종목은 매수 후보에서 제외
26. **읽는 법 헤더 배치 (v6)**: 모든 메시지에서 데이터 목록 위에 해석 가이드 배치
27. **Part 1 채널 발송 (v6)**: GitHub Actions 실행 시 Part 1도 채널로 발송
28. **세그먼트 캡 ±100% (v5)**: Score 이상치 방지 (ELS: 942→9.3)
29. **Part 2 EPS/주가 90일 변화율 (v9)**: 직관적 실제값 표시 (가중평균에서 변경)
30. **"이익" → "EPS 전망치" (v5)**: NTM이므로 전망치임을 명확히. 첫 등장시 "(향후 12개월 주당순이익 예상)" 부연
31. **친절한 말투 (v5)**: "~예요/~해요" 어체 통일, 구체적 예시와 수치 포함
32. **Score → "EPS 점수" (v7)**: 고객 표시명 변경, 상승 폭+지속성 종합 설명
33. **턴어라운드 Score > 3 필터 (v7)**: 고정 Top 10 → 품질 필터 후 전체 표시
34. **발송 순서 (v9)**: Part 1→Part 2→AI 리스크 체크→시스템 로그 (4종)
35. **Part 2 핵심 문구 (v7)**: "오늘의 핵심 리포트예요" 인트로 추가
36. **3줄 레이아웃 변경 (v7)**: 순위+종목명 / 섹터+데이터 / 신호등 (종목명 우선)
37. **AI 소거법 전환 (v10)**: 뉴스 스캐너→리스크 스캐너, 호재 제거, 🚫/📅/✅ 3단 구조
38. **AI 상시 리스크 금지 (v10)**: "경쟁 심화" 같은 업종 일반론 차단, 최근 실제 뉴스만
39. **AI anti-hallucination (v10)**: Google 검색 결과에 없으면 ✅로 분류, temperature 0.2
40. **AI 구분선 후처리 (v10)**: 🚫 섹션 종목 간 ────── 삽입 (코드, Gemini 비의존)
41. **AI 재무 리스크 항목 (v10)**: 신용등급 하향, 유동성 위기, 파산 우려 뉴스 보고

---

## 미결 사항 ❓

(모두 해결됨 — 코드 마이그레이션 완료, 업종 매핑 130개 구현 완료)

---

## 폐기 대상 (기존 시스템)

| 항목 | 이유 |
|------|------|
| score_321 | NTM Score로 대체 |
| quality_score (100점) | NTM Score로 대체 |
| Kill Switch (7d -1%) | seg1이 자연 감점 |
| 이상치 필터 (60d > 200%) | $1 기준으로 턴어라운드 분리 |
| passed_screen 플래그 | score 랭킹으로 대체 |
| 기존 eps_snapshots 테이블 | ntm_screening으로 대체, **삭제** |
| MA200/RSI/action 로직 | Part 2에서 괴리율로 대체 |
| get_action_label() | 폐기 |
| is_actionable() | 폐기 |

---

## DB 스키마 (새)

```sql
CREATE TABLE ntm_screening (
    date        TEXT,     -- 스크리닝 날짜
    ticker      TEXT,     -- 종목
    rank        INTEGER,  -- 그날의 순위 (Score 기준, 턴어라운드는 0)
    score       REAL,     -- seg1+seg2+seg3+seg4 (내부 필터링용)
    ntm_current REAL,     -- NTM EPS 현재 추정치
    ntm_7d      REAL,     -- NTM EPS 7일 전 추정치
    ntm_30d     REAL,     -- NTM EPS 30일 전 추정치
    ntm_60d     REAL,     -- NTM EPS 60일 전 추정치
    ntm_90d     REAL,     -- NTM EPS 90일 전 추정치
    is_turnaround INTEGER DEFAULT 0,  -- |NTM| < $1.00 여부
    PRIMARY KEY (date, ticker)
);
```

**설계 근거:**
- 원본 5개 NTM 값 보존 → 나중에 공식 바꿔도 재계산 가능
- 전 종목 저장 → 순위 진입/이탈 추적, 3개월 후 수익률 상관관계 분석
- 패턴/괴리율은 5개 값에서 파생 → 별도 컬럼 불필요
- is_turnaround 플래그로 메인/턴어라운드 구분

---

## 기술 참고

### 데이터 접근 방법

```python
# NTM 계산에 필요한 데이터
stock = yf.Ticker(ticker)
eps_trend = stock.eps_trend                    # 5개 시점 × 4개 기간
raw_trend = stock._analysis._earnings_trend    # endDate 포함

# endDate 추출
for item in raw_trend:
    period = item['period']      # '0y', '+1y'
    end_date = item['endDate']   # '2026-12-31'

# 업종 정보
industry = stock.info.get('industry', 'N/A')   # ex: "Semiconductors"
```

### NTM 계산 핵심 코드

```python
# 각 snapshot별 시간 가중 NTM 계산
snapshots = {'current': 0, '7daysAgo': 7, '30daysAgo': 30, '60daysAgo': 60, '90daysAgo': 90}
for col, days_ago in snapshots.items():
    ref = today - timedelta(days=days_ago)
    we = ref + timedelta(days=365)
    o0d = max(0, (min(we, fy0_end) - max(ref, fy0_start)).days)
    o1d = max(0, (min(we, fy1_end) - max(ref, fy1_start)).days)
    total = o0d + o1d
    ntm[col] = (o0d/total) * eps_0y + (o1d/total) * eps_1y

# 턴어라운드 판별 (양 끝점만 체크)
is_turnaround = abs(ntm_current) < 1.0 or abs(ntm_90d) < 1.0

# Score는 Part 1 정렬 기준 (세그먼트 캡 ±100%)
SEG_CAP = 100
seg1 = clamp(-SEG_CAP, (ntm_cur - ntm_7d) / abs(ntm_7d) * 100, SEG_CAP)
score = seg1 + seg2 + seg3 + seg4

# 괴리율 (Part 2 정렬 기준, 가중평균 Fwd PE 변화)
weights = {7d: 0.4, 30d: 0.3, 60d: 0.2, 90d: 0.1}
fwd_pe_chg = weighted_avg(pe_change_per_period, weights)

# Part 2 표시: EPS/주가 가중평균 변화율
eps_chg_weighted = weighted_avg(eps_change_per_period, weights)
price_chg_weighted = weighted_avg(price_change_per_period, weights)
```

---

## Phase 7: AI 리스크 검증 도입 (v8)

### 7-1. LLM 선정

- Claude Max 구독($110/월)은 API 접근 불포함 → GitHub Actions 자동화 불가
- Gemini Pro 구독 보유, but Gemini 2.5 Pro 무료 티어 quota=0 (429 RESOURCE_EXHAUSTED)
- **Gemini 2.5 Flash**: 무료 티어 사용 가능, 1.5 Pro보다 성능 우수 → 채택

### 7-2. AI 역할 정의: "추천"이 아닌 "검증"

시스템이 이미 매수 후보를 선별했으므로, AI의 역할은 **리스크 검증/필터링**:
- "사도 되는 것" vs "사면 안 되는 것" 판별
- 시스템이 못 보는 6가지 영역 보완:
  ① EPS 품질 (매출 성장 vs 비용절감 vs 일회성)
  ② 악재 유무 (소송, 규제, 경쟁, 대주주 매도)
  ③ 밸류에이션 (동종업계 대비 Fwd PE)
  ④ 재무 건전성 (부채, FCF)
  ⑤ 실적 발표 타이밍
  ⑥ 내부자/기관 동향

### 7-3. 프롬프트 설계 (5회 반복)

- v1: "추천 5개" → 너무 단순
- v2: 6개 체크포인트 추가 → 섹터 분석 리포트가 되어버림
- v3: 사용자 "섹터분석을 하라는게 아니야" → 방향 수정
- v4: "추천" → "검증/필터링"으로 역할 전환
- v5 (최종): 시스템 설명 + 검증 관점 6개 + 출력 형식 3000자

핵심 결정:
- Part 2가 검증 대상, Part 1/Turnaround는 참고 데이터
- EPS%/주가% 수치는 시스템 내부 가중평균이므로 AI가 인용 금지
- Google Search Grounding으로 실시간 웹 검색 활성화

### 7-4. 메시지 체계 변경

v8에서 5종으로 확장 후, v9에서 턴어라운드 메시지 제거하여 4종으로 축소:
Part 1 → Part 2 → AI 리스크 체크 → 시스템 로그
AI 분석은 개인봇에만 전송 (로컬/GitHub Actions 모두)

### 7-5. 기술 구현

- SDK: `google-genai>=1.0.0` (NOT google-generativeai)
- Markdown→HTML 변환: `**bold**` → `<b>`, `*italic*` → `<i>`, `#` headers strip
- `run_ai_analysis()` 함수: daily_runner.py lines 681-793

### 시뮬레이션 스크립트 (개발 시 사용, 현재 프로젝트에 미포함)
개발 과정에서 ntm_simulation.py, ntm_sim.py, ntm_sim2.py, collect_industries.py 등을 사용.
프로덕션 코드(daily_runner.py + eps_momentum_system.py)에 모두 반영 완료되어 삭제됨.

---

## Phase 8: UX 개선 & 시스템 철학 정립 (v9)

### 8-1. 6단계 트래픽 라이트 (네모=강한 변동)

4단계에서 6단계로 확장. 도형의 모양(네모 vs 동그라미)으로 변동폭 크기 표현:
- 🟩 폭발적 상승 (>20%) — 네모
- 🟢 상승 (2~20%)
- 🔵 양호 (0.5~2%)
- 🟡 보합 (0~0.5%)
- 🔴 하락 (0~-10%)
- 🟥 급락 (<-10%) — 네모

**결정 근거**: Score는 총합(magnitude), 신호등은 패턴(direction) — 두 가지 보완적 차원.
기존 4단계는 방향만 표시했으나, 🟩🟥 추가로 magnitude 정보도 부분 반영.
데이터 분포: 🟩 출현률 0.5%, 🟥 출현률 1.2% — 희귀해서 의미 있음.

### 8-2. 턴어라운드 메시지 제거

**제거 이유**:
- ALB 같은 종목: NTM $0.24→$2.61이지만 진짜 턴어라운드가 아닌 저 베이스 EPS
- EPS 추정치 부호 변환(적자→흑자)이 실제 주가를 움직이는 경우는 극소수
- 내부 is_turnaround 플래그는 Score 왜곡 방지용으로 유지, 고객 메시지에서만 제거

### 8-3. AI 역할 변경: 분석가 → 뉴스 스캐너 → 리스크 스캐너

**v8**: 6가지 체크포인트로 분석 → 메시지 폭발, 부정확한 판단
**v9**: 팩트만 전달하는 뉴스 스캐너 → 실적 숫자 나열 문제
**v10**: 리스크 소거법으로 전환 (프롬프트 5회 반복 튜닝)

**v10 최종 설계 — 소거법**:
시스템이 이미 좋은 종목을 골랐으니, AI는 "숨은 위험"만 찾아서 걸러냄.
리스크 미발견 종목 = 진짜 매수 후보.

출력 구조:
- 📰 이번 주 시장: 매크로 이벤트 2-3줄
- 🚫 주의: 최근 1~2주 실제 리스크 뉴스만 (종목 간 구분선)
- 📅 어닝 주의: 2주 내 실적발표 임박 종목
- ✅ 리스크 미발견: 나머지 종목 나열

**프롬프트 튜닝 과정 (5회)**:
1. v9 뉴스 스캐너 → 실적 숫자 나열 문제 (SNDK 매출 상회, ASML 29% 증가 등)
2. 리스크+호재 분리 → 같은 종목에 리스크/호재 공존 → 판단 더 혼란
3. 섹터 그룹화 시도 → 정보량 늘었으나 여전히 혼란
4. 소거법 전환(리스크만) → 상시 리스크 일반론 생성 ("경쟁 심화", "가격 변동성")
5. anti-hallucination 강화 + 예시 기반 출력 형식 → 최종 안정화

**핵심 결정들**:
- 호재 보고 제거: Part 2가 이미 좋은 종목을 골랐음 → AI가 호재 반복은 무의미
- 상시 리스크 금지: "연료비 변동성" 같은 업종 상시 리스크 ≠ 최근 뉴스
- anti-hallucination: Google 검색 결과에 없으면 ✅로 분류
- temperature 0.7→0.2: hallucination 억제
- 구분선 후처리: Gemini 출력 후 🚫 섹션 bullet 사이에 ────── 삽입 (코드)

### 8-4. Part 2 Score 기준 상향 (3→10)

**문제**: Score > 3은 양수 종목의 50%(307개)를 통과 → 필터가 아닌 반쪽짜리 통과
- 41%가 90일 EPS 변화 5% 미만 (노이즈 수준)
- Part 1 30위(17.6)의 1/6 수준인 종목이 "매수 후보"에 올라옴

**결정**: Score > 10 (64종목, 상위 10%)
- 신흥강자도 EPS가 2주 내 10%+ 뛰면 통과 가능 (매일 실행이므로 놓치지 않음)

### 8-5. Part 2 표시값 변경

**기존**: 가중평균 EPS%/주가% → 내부 계산값이라 고객이 이해 불가
**변경**: 90일 대비 EPS 추정치 변화율 & 주가 변화율 (직관적 실제값)
- 정렬 기준(가중평균 Fwd PE 변화)은 유지, 표시만 변경

### 8-8. Part 2 괴리율 가중치 검토 — 최근가중 유지 결정

**현재**: 7d×40% + 30d×30% + 60d×20% + 90d×10% (최근가중)

3가지 방식 비교 검토:
| 방식 | 장점 | 단점 |
|------|------|------|
| **최근가중 (현행)** | 괴리 방향 구분 가능 | 7d 노이즈에 민감 |
| 동일가중 (25%씩) | 다시점 확인으로 안정적 | 좁혀지는/벌어지는 괴리 구분 불가 |
| 단순 90d | 직관적, 총 괴리 반영 | 단일 시점, 노이즈 취약 |

**핵심 발견 — 동일가중의 맹점:**
```
종목 X (시장이 따라잡는 중): 7d -5%, 30d -10%, 60d -15%, 90d -20%
종목 Y (지금 벌어지는 중):  7d -20%, 30d -15%, 60d -5%,  90d 0%
동일가중: 둘 다 -12.5% (구분 불가!)
최근가중: X=-10.0%, Y=-13.5% (Y가 더 높음 ✓)
```
종목 X는 PE가 회복 중(시장이 이미 따라잡는 중), 종목 Y는 지금 벌어지는 중(신선한 기회).
Part 2 취지("주가가 아직 못 따라간 종목")에는 Y가 더 맞고, 최근가중만 이를 구분함.

**결정**: 최근가중 유지. "지금 벌어지고 있는 괴리"에 높은 점수를 주는 것이 Part 2 아젠다에 부합.

### 8-9. Part 1 Score 가중치 검토 — 동일가중(현행) 유지 결정

**질문**: Part 2처럼 Part 1 Score에도 최근가중을 넣으면 가속 중인 종목이 더 높은 평가를 받지 않을까?

**핵심 발견 — 세그먼트 기간 비대칭으로 이미 최근가중 내재:**
```
seg1: 7d→오늘   (7일)  → Score 25% → 일당 3.6%
seg2: 30d→7d   (23일) → Score 25% → 일당 1.1%
seg3: 60d→30d  (30일) → Score 25% → 일당 0.83%
seg4: 90d→60d  (30일) → Score 25% → 일당 0.83%
```
seg1은 7일치인데 Score의 25%를 차지 → **일당 비중이 seg3/seg4의 4.3배**.
동일한 5% 변화라도 seg1(7일)에서 발생하면 seg3(30일)보다 4배 빠른 속도의 변화이며, Score에는 동일하게 반영됨.

**결정**: 현행 유지. 세그먼트 구조 자체가 이미 강한 최근가중을 내포하고 있어, 명시적 가중치를 추가하면 이중 가중이 됨.

### 8-6. ⚠️ 경고 간소화

경고 텍스트 줄 제거, ⚠️ 아이콘만 유지. AI 뉴스 스캐너가 해당 종목의 실제 뉴스를 찾아주므로 보완됨.

### 8-7. 프로젝트 정리

- `setup_scheduler.ps1` 삭제 (레거시, GitHub Actions가 대체)
- `create_turnaround_message()` 함수 삭제 (데드 코드)
- 시스템 로그 aligned_count: 🟢==4 체크 → 🔴🟥 미포함 체크로 수정

### 8-8. 방향 보정 (adj_score) 도입

**배경**: Score는 EPS 변화의 "크기"만 반영. 같은 Score라도 최근 가속 vs 최근 꺾임은 질적으로 다름.
고객은 순위 위주로 보기 때문에, 패턴 품질이 순위(Score)에 반영되어야 함.

**논의 과정**:
1. 카테고리 방식 (7개 패턴 × 고정 보너스) vs 연속 공식 비교
2. 카테고리 방식: 자의적 파라미터 14개+, 경계값 절벽 문제
3. 연속 공식: 파라미터 1개(÷30), 통계적 근거(1σ=12%), 매끄러운 보정

**최종 공식**:
```
recent = (seg1 + seg2) / 2
old = (seg3 + seg4) / 2
direction = recent - old
adj_score = score × (1 + clamp(direction / 30, -0.3, +0.3))
```
- ÷30 근거: direction 표준편차 3.67, 1σ → 12% 보정이 적절
- ±30% 캡으로 극단값 제한

**효과** (2026-02-08 데이터):
- Part 1 Top 30: 꺾임 종목 제거 (3.3%→0%), 가속 비율 증가 (50%→60%)
- 대표 예시: AR(direction -19.5, 꺾임) 19위→27위, ASML(+6.0, 가속) 35위→28위

### 8-9. Part 2 필터 기준: adj_score > 9

**논의**: 8, 9, 10 세 기준 비교.
- adj>10: 64종목 — 보수적
- adj>9: 71종목 — 10→9 추가 7종목 중 5개 가속 패턴, 꺾임 0개 (품질 유지)
- adj>8: 86종목 — 9→8 추가 15종목 중 꺾임 4개 (품질 하락, 꺾임 비율 5.6%→9.3%)

**결정**: adj_score > 9. 후보 풀을 넓히되 품질은 유지하는 최적 지점.
Top 30은 세 기준 모두 동일 (30위 adj_score=17.7로 기준과 무관).

---

## Phase 9: Part 2 매수 후보 품질 판별 강화 (v12)

### 9-1. 매출·재무 리스크 검토 — Layer 2 탐색과 포기

**문제**: Part 2가 EPS 모멘텀+가격 괴리로 30종목을 골라주지만, 매출 성장이나 재무 리스크 체크가 없어 어떤 종목을 살지 판단하기 어려움.

**탐색 과정**:
1. `_earnings_trend`에 `revenueEstimate` 데이터 발견 → NO 추가 API 호출 필요
2. 그러나 revenue estimate에는 historical snapshot(7d/30d/60d/90d 전) 없음 → 변화 추세 추적 불가
3. **핵심 발견**: Part 2 종목(adj_score > 9, EPS > 0)은 거의 전부 NTM Revenue Growth 양수 → **변별력 없음**
4. Revenue direction display 포기 → Revision Breadth(변별력 있음)로 전환

### 9-2. 트래픽 라이트 설명 리디자인 (15개 → 8패턴 + 강도 수식어)

**문제**: 기존 15개 카테고리가 과도하게 세분화. 비슷한 표현들이 고객을 혼란시킴.

**새 설계**: 8개 기본 패턴 + 🟩🟥 강도 수식어

기본 패턴 (base):
- **횡보**: flat 3개 이상
- **하락**: neg 3개 이상
- **전구간 상승**: neg 0, 최근≈과거
- **상향 가속**: neg 0, 최근 > 과거 + 2
- **상향 둔화**: neg 0, 과거 > 최근 + 2
- **반등**: 과거 neg 우세 → 최근 pos 우세, 최근avg > 과거avg
- **추세 전환**: 과거 pos 우세 → 최근 neg 우세, 과거avg > 최근avg
- **등락 반복**: 위 어디에도 해당 안 됨

강도 수식어:
- 🟩 + 🟥 → 급등락/급락 후 반등/급격한 전환 (base에 따라)
- 🟩 → 폭발적 상승/폭발적 가속/폭발적 반등
- 🟥 → 급락/급격한 전환/급락 후 반등/급등락

**Score = magnitude + direction (adj_score에 통합), lights = 시각적 패턴 표시** — 보완적 역할.

### 9-3. Part 2 라인 3 강화: 괴리율 표시

**문제**: EPS%, 주가% 변화율만 보여주면 순위 기준(괴리율)이 보이지 않음. Type A(EPS 크게 상승, 주가도 오르지만 덜) vs Type B(EPS 소폭 상승, 주가 급락)의 구분 필요.

**변경**:
```
EPS +45.2% / 주가 +12.1% · 괴리 -28.3
```
- 괴리 = Fwd PE 가중평균 변화. 마이너스 = EPS 대비 주가 미반영도 (순위 기준)
- 고객이 "왜 이 순서인가" 이해 가능

### 9-4. Part 2 라인 4 추가: 애널리스트 의견

**변경**: `의견 ↑N ↓N` (30일간 EPS 상향/하향 수정 애널리스트 수)

**설계 결정들**:
- 한글 라벨("전원 상향", "상향 우세") 대신 숫자 표기 → 트래픽 라이트 설명과 시각적 혼동 방지
- `epsRevisions.upLast30days`, `downLast30days` 사용 (이미 캐시된 `_earnings_trend`에서)
- 0y 기간 데이터 사용 (당기)
- 의견이 0↑0↓인 경우도 그대로 표시 (중립 = 무관심 = 사용자가 판단)

### 9-5. 읽는 법 헤더 업데이트

Part 2 읽는 법에 추가:
```
괴리 = EPS 대비 주가 미반영도 (순위 기준)
의견 ↑↓ = 30일간 EPS 상향/하향 애널리스트 수
```

### 9-6. 트래픽 라이트 12패턴 확장 (v13)

**문제**: v12의 8패턴에서 "상향 가속"이 Top 30 중 12개(40%)에 해당. 신호등 모양이 🟢🟢🟢🟢, 🔵🔵🟢🟢, 🟡🟢🟢🔵, 🟡🔵🔵🟢로 다른데 문구가 동일하여 혼란.
- **원인**: `recent_avg - old_avg > 2` 기준이 너무 느슨. 2점 평균만으로 4세그먼트 형태 구분 불가.

**해결**: neg_count==0 분기에서 **피크 위치 + 형태 분석**으로 5개 하위 패턴 분화:
- **전구간 상승**: 전체 평균 < 1.5 (미미한 변동)
- **꾸준한 상승**: spread/mean < 0.8 (균일한 분포)
- **최근 급상향**: seg1(최근)이 피크, 나머지 평균의 3배 초과
- **상향 가속**: seg1이 피크이나 점진적 증가 / seg2 피크이나 seg1 유지
- **중반 강세**: seg2가 피크, seg1이 피크의 60% 미만 (정점 지남)
- **상향 둔화**: seg3/seg4(초반)가 피크

**동률 처리**: `segs.index(max_seg)` → `max(range(4), key=lambda i: (segs[i], i))` — 동률 시 최근(오른쪽) 우선

**수식어 추가**:
- 🟩 + 최근 급상향 → "폭발적 급상향"
- 🟩 + 중반 강세 → "중반 급등"
- 🟩 + 상향 둔화 → "급등 후 둔화"
- 🟩 + 꾸준한 상승 → "폭발적 상승"

**진동 감지 추가**:
양수 영역 내 zigzag 패턴 (high-low-high-low) 감지:
- 인접 구간 차이 부호가 3번 교차 (`signs[0]*signs[1] < 0 and signs[1]*signs[2] < 0`)
- 최소 진폭 > 3 (미세 변동 제외)
- "상승 등락" (🟩 수식어 → "폭발적 등락")
- TLN [17.1→1.3→9.7→1.1], FIVE [11.2→1.2→9.2→1.6], MSTR [62.9→0.2→43.5→14.4] 감지

**결과**: 12개 "상향 가속" → 11개 카테고리로 분산 (최대 5개/카테고리, 17%)

### 9-7. 매출 성장 필터 검토 — 불필요, 도입 안 함

**질문**: EPS 전망치 상향이 진짜 회사 성장인지, 비용절감/자사주매입인지 구분하려면 매출 성장 필터가 필요하지 않은가?

**검증** (2026-02-08 데이터, adj_score > 9 종목 71개):
- YoY 매출 10%↑: 43개 (60.6%), 평균 adj_score **31.06**
- YoY 매출 0~10%: 19개 (26.8%), 평균 adj_score 21.29
- YoY 매출 역성장: 9개 (12.7%), 평균 adj_score **11.25** (하위권 집중)

**핵심 발견**:
- Top 30 내 매출 역성장 종목: **0개** (필터 없이도 자연 정렬)
- Top 10 중 10%↑ 성장: 9/10 (90%)
- 매출 역성장 9종목은 전부 adj_score 9~13 하위권 (ROIV, MRNA, TKO, BRK-B, SMCI 등)
- adj_score가 높을수록 매출 성장도 강한 양의 상관관계

**결정**: 매출 필터 도입 안 함.
- adj_score가 이미 매출 성장과 자연 상관 → 별도 필터 불필요
- 추가 시 916종목 × quarterly_income_stmt API 호출 → 수집 시간 대폭 증가
- 애널리스트 EPS 전망치 상향 자체가 대부분 매출 성장 전망에 기반 (자사주매입은 이미 모델에 반영)

---

*v1 작성: Claude Opus 4.6 | 2026-02-06 직장 PC*
*v2 업데이트: Claude Opus 4.6 | 2026-02-06 집 PC*
*v3 업데이트: Claude Opus 4.6 | 2026-02-06 집 PC — 시뮬레이션 결과 & Part 2 재설계*
*v4 업데이트: Claude Opus 4.6 | 2026-02-06 집 PC — 텔레그램 포맷 & 발송 채널 확정*
*v5 업데이트: Claude Opus 4.6 | 2026-02-07 집 PC — 모바일 UI 리디자인, 고객 친화적 말투*
*v6 업데이트: Claude Opus 4.6 | 2026-02-07 집 PC — 트래픽 라이트, ⚠️ 경고, EPS>0 필터, 코드 정리*
*v7 업데이트: Claude Opus 4.6 | 2026-02-07 집 PC — 4단계 신호등, Score 정렬, 가중평균, 친절한 말투, MD 정리*
*v8 업데이트: Claude Opus 4.6 | 2026-02-07 집 PC — Gemini 2.5 Flash AI 리스크 검증, Google Search Grounding*
*v9 업데이트: Claude Opus 4.6 | 2026-02-08 집 PC — 6단계 라이트, AI 뉴스 스캐너, 턴어라운드 제거, Score>10, Part 2 표시값*
*v10 업데이트: Claude Opus 4.6 | 2026-02-08 집 PC — AI 리스크 소거법, 프롬프트 5회 튜닝, 구분선 후처리, temperature 0.2*
*v11 업데이트: Claude Opus 4.6 | 2026-02-08 집 PC — 방향 보정(adj_score) 도입, adj_score > 9*
*v12 업데이트: Claude Opus 4.6 | 2026-02-08 집 PC — 트래픽 라이트 8패턴, Part 2 괴리율+의견 표시*
*v13 업데이트: Claude Opus 4.6 | 2026-02-08 집 PC — 트래픽 라이트 12패턴 (피크 위치 + 진동 감지, 상향 가속 과다 해결)*

---

## Phase 10: AI 뉴스 스캐너 → AI 브리핑 전환 (v14)

### 10-1. 뉴스 스캐너의 근본적 한계 발견

**문제**: v10 소거법으로 30종목 리스크 스캔 시도 → 실패 반복

**시도와 실패 기록**:
1. **구조화 티커 + 안티할루시네이션** → 30종목 중 리스크 2개만 발견, 📅 섹션에서 23개 가짜 어닝 날짜 할루시네이션
2. **섹터 기반 + 개별 Top 10** → 모든 섹터 "검색되지 않았습니다", 모든 종목 "해당 없음"
3. **뉴스 허용 범위 확대 (리스크→긍정/부정 모두)** + temperature 상향 → API 한도(20회/일) 소진

**근본 원인 발견**: Gemini + Google Search Grounding은 요청당 5-8개 검색 쿼리만 생성. 30종목 개별 검색은 구조적으로 불가능.

### 10-2. 설계 전환: "검색은 코드가, 분석은 AI가"

**핵심 인사이트**: AI에게 검색을 시키면 할루시네이션 + 불완전 결과. 코드가 팩트를 수집하고 AI는 해석만 하면 할루시네이션 구조적 불가.

**새 구조**:
| 섹션 | 데이터 소스 | AI 역할 |
|------|-----------|---------|
| 📰 시장 동향 | Google Search (1회, 광범위 쿼리) | 검색 결과 요약 |
| 📊 매수 후보 분석 | results_df (코드가 구성) | 데이터 해석/인사이트 |
| 📅 어닝 주의 | yfinance stock.calendar (코드가 조회) | 그대로 표시만 |

**제거된 것**: 🚫 개별 종목 리스크 스캔, ✅ 리스크 미발견 목록, 구분선 후처리

### 10-3. 어닝 일정: yfinance 직접 조회

**문제**: Gemini가 어닝 날짜를 라운드로빈으로 할루시네이션 (23개 가짜 날짜 생성)

**해결**: yfinance `stock.calendar.get('Earnings Date', [])` 직접 조회
```python
for ticker, _ in part2_stocks:
    stock = yf.Ticker(ticker)
    cal = stock.calendar
    earn_dates = cal.get('Earnings Date', [])
    for ed in earn_dates:
        if today_date <= ed <= two_weeks_date:
            earnings_tickers.append(f"{ticker} {ed.month}/{ed.day}")
```
- 결과: NEM 2/20, RGLD 2/19 정확히 조회됨
- 프롬프트에 `[어닝 일정 — 시스템 확인 완료]`로 전달, AI는 수정/추가 금지

### 10-4. 매수 후보 데이터: results_df 직접 구성

**문제**: msg_part2=None일 때 Gemini가 "데이터가 없다"고 응답

**해결**: msg_part2 텍스트 파싱 대신 results_df에서 직접 데이터 구성
```python
data_lines.append(
    f"{idx+1}. {t} ({ind}) {lights} {desc} · "
    f"점수 {asc:.1f} · EPS {eps_c:+.1f}% · 주가 {price_c:+.1f}% · "
    f"괴리 {pe_c:+.1f} · 의견 ↑{rup} ↓{rdn}{warn}"
)
```
- 함수 시그니처 변경: `run_ai_analysis(..., results_df=None)`

### 10-5. 청크 분할 버그 수정

**문제**: 텔레그램에 빈 메시지 48개 전송됨

**원인**: `split_point = remaining[:4000].rfind('\n')` → 첫 4000자에 개행 없으면 `split_point==-1` → 무한루프 + 빈 청크 생성

**수정**:
```python
if split_point <= 0:
    split_point = 4000
remaining = remaining[split_point:].strip()
chunks = [c for c in chunks if c.strip()]  # 빈 청크 제거
```

### 10-6. temperature 및 기타

- temperature: 0.2 → 0.3 (0.2는 빈 응답 발생, 0.3이 안정적)
- 빈 응답 시 1회 재시도 로직 추가
- 헤더: "AI 리스크 체크" → "AI 브리핑"
- 설명: "리스크를 소거법으로 스캔" → "매수 후보 데이터를 AI가 분석한 브리핑"

### 결정 사항 추가

42. **AI 브리핑 전환 (v14)**: 소거법→데이터 분석, "검색은 코드가, 분석은 AI가"
43. **어닝 yfinance 직접 조회 (v14)**: AI 할루시네이션 방지, stock.calendar 사용
44. **results_df 직접 전달 (v14)**: msg_part2 텍스트 파싱 대신 DataFrame에서 구조화 데이터 구성
45. **청크 분할 수정 (v14)**: split_point <= 0 방어, 빈 청크 필터링
46. **temperature 0.3 (v14)**: 0.2는 빈 응답 위험, 0.3이 데이터 분석에 적합

*v14 업데이트: Claude Opus 4.6 | 2026-02-08 집 PC — AI 뉴스 스캐너→AI 브리핑 (검색은 코드가, 분석은 AI가)*

---

## Phase 11: AI 브리핑 정량 리스크 스캐너 전환 (v15)

### 11-1. v14 AI 브리핑의 한계

**문제**: v14는 Part 2 데이터를 요약해주는 구조 → 고객이 이미 본 내용의 반복. 가독성 떨어지고 실질 가치 없음.
**고객 니즈**: Part 2 매수 후보의 숨은 리스크를 체크하여 매매 판단 보조.

### 11-2. 뉴스 기반 접근 시도 → 실패

yfinance `stock.news` → `content.title/summary/pubDate`로 종목별 뉴스 수집 시도:
- yfinance 뉴스는 큐레이션 피드로 종목별 리스크 신호가 약함 (저신호 고노이즈)
- Google Search Grounding 시장 동향도 부정확 (나스닥 상승을 하락이라 보고)
- 16/30 종목 위험 판정 → 과도한 false positive

### 11-3. 정량 리스크 스캐너 전환 (최종)

**핵심 아이디어** (사용자): "PART2에 나온 위험 신호들을 정리해서 AI한테 전달하면 AI가 그거 기반으로 사면 위험한 종목과 이유 말해주는거 어때?"

**6가지 정량 위험 플래그** (코드가 results_df에서 계산):

| 플래그 | 조건 | 이모지 |
|--------|------|--------|
| 의견 하향 (강) | `rev_down >= 3` | 🔻 |
| 의견 하향 (약) | `rev_down >= 1 and rev_down >= rev_up` | 📉 |
| 극단적 괴리 | EPS 가중↑ & 주가 가중↓, 비율 5배 초과 | ⚠️ |
| 주가 급락 | `price_chg < -20%` (90일) | 📉 |
| 모멘텀 감속 | `direction < -10` | ↘️ |
| 고평가 | `fwd_pe > 50` | 💰 |
| 어닝 임박 | yfinance `stock.calendar` 2주 이내 | 📅 |

**Gemini 역할**: 위험 플래그를 해석하여 고객에게 친근한 말투로 설명. 팩트에 없는 내용 생성 금지.

### 11-4. 출력 구조

```
━━━━━━━━━━━━━━━━━━━
      🤖 AI 브리핑
━━━━━━━━━━━━━━━━━━━

📰 시장 동향 (Google Search 2~3줄)

⚠️ 매수 주의 종목
종목명(티커)
리스크 설명 1~2줄 (~예요/~해요 체)
──────────────────
다음 종목...

📅 어닝 주의
종목명 날짜 · ...

✅ 위험 신호 없음
종목명(티커) · 종목명(티커) · ...
```

### 11-5. UI/말투 개선

- **[SEP] 마커 → 분리선**: Gemini에게 `[SEP]` 출력 지시 → 코드에서 `──────────────────`로 변환
- **여백 축소**: `re.sub(r'\n*\[SEP\]\n*', '\n──────────────────\n', ...)` — 빈 줄 제거
- **말투**: 프롬프트에 구체적 예시 제공 ("주가가 크게 빠졌어요", "조심하시는 게 좋겠어요")
- **종목명 볼드**: `**종목명(티커)**` → `<b>종목명(티커)</b>`

### 11-6. Gemini response.text None 대응

Google Search Grounding 사용 시 `response.text`가 None 반환하는 케이스 발견.
`extract_text()` 헬퍼로 `candidates[0].content.parts`에서 직접 추출하도록 수정.

### 11-7. 테스트 인프라

- `send_ai_briefing.py`: AI 브리핑만 테스트 발송 (개인봇)
- `.github/workflows/ai-briefing-only.yml`: 수동 트리거 워크플로우
- **교훈**: 포맷 변경은 기존 출력을 재가공하여 테스트. 매번 916종목 재수집 불필요.

### 결정 사항 추가

47. **AI 정량 리스크 스캐너 (v15)**: 뉴스→정량 신호 기반, 할루시네이션 구조적 차단
48. **[SEP] 종목 분리선 (v15)**: AI 출력에 마커, 코드에서 분리선 변환 (여백 최소화)
49. **친근한 말투 프롬프트 (v15)**: 구체적 예시 기반 (~예요/~해요), 추상적 지시 불충분
50. **extract_text 헬퍼 (v15)**: Gemini response.text None 대응, parts 직접 추출
51. **temperature 0.2 유지 (v15)**: 정량 데이터 해석이므로 낮은 temperature 적합
52. **✅ 섹션 티커만 5개씩 줄바꿈 (v15)**: 종목명(티커) 한줄 나열 → 티커만 5개씩 줄바꿈으로 가독성 개선

*v15 업데이트: Claude Opus 4.6 | 2026-02-09 집 PC — AI 정량 리스크 스캐너, UI/말투 개선, extract_text 안정화*

## Phase 12: 포트폴리오 추천 기능 (v16)

### 12-1. 목적

Part 1→Part 2→AI 브리핑 흐름에 최종 액션 아이템 추가.
916종목 → 30종목(Part 2) → 리스크 제거 → 추세 반영 → **최종 5종목 포트폴리오**.

### 12-2. 선정 로직

1. Part 2 필터 (adj_score > 9, fwd_pe_chg, eps_change_90d > 0) → 30종목
2. 리스크 플래그 6가지로 위험 종목 제거 → ✅ 종목만
3. **괴리율 × 추세 3단계 가중치** = `weighted_gap`
   - 좋음 (상향 가속, 꾸준한 상승, 폭발적 등): **x1.2**
   - 보통 (중반 강세, 반등, 등락 등): **x1.0**
   - 나쁨 (둔화, 전환, 하락, 횡보): **x0.8**
4. weighted_gap 내림차순 상위 5개 선정
5. 비중 배분: 괴리율 비례, 5% 단위, 최소 10%

### 12-3. 추세 가중치 설계 경위

- 처음: 복합점수 (괴리율 40% + 모멘텀 35% + 컨센서스 25%) → 과적합 위험
- "모멘텀 기반으로 싼 거 찾는 건데 왜 모멘텀을 또 더해?" → 모멘텀 제거
- 순수 괴리율 → "Part 2랑 똑같잖아" → 추세 가중치 도입
- 20개 세분화 가중치 → "임의로 정한 거라 불안" → 3단계(±20%) 대칭으로 단순화
- 3단계 vs 세분화 비교: TOP 5 종목 동일, 3~4위 순서만 다름 → 3단계 채택

### 12-4. 메시지 구조

```
━━━━━━━━━━━━━━━━━━━
      💼 추천 포트폴리오
━━━━━━━━━━━━━━━━━━━
📅 2026년 02월 09일

Part 2 매수 후보 중 위험 신호 종목을 제거하고,
EPS 추세 품질을 반영하여 선정했어요.

(Gemini 생성: 종목별 비중 + 선정 이유, [SEP] 구분)
```

### 12-5. 전체 메시지 흐름

Part 1 (모멘텀 순위) → Part 2 (괴리율 순) → AI 브리핑 (리스크) → **포트폴리오 (최종 추천)** → 시스템 로그

### 12-6. Part 2 UI 압축

종목당 4줄→3줄: 의견(↑N ↓N)을 변화율 줄에 합침.

### 결정 사항 추가

53. **포트폴리오 추천 (v16)**: Part 2 ✅ 종목 → 괴리율×추세가중 → 상위 5개
54. **추세 3단계 가중치 (v16)**: ±20% 대칭, 과적합 최소화 (1.2/1.0/0.8)
55. **Part 2 UI 압축 (v16)**: 종목당 4줄→3줄, 의견을 변화율 줄에 합침

56. **테스트 인프라 정리 (v16)**: ai-briefing-only.yml, send_ai_briefing.py 삭제 — 실전 전환
57. **전체 메시지 흐름 확정 (v16)**: Part1 → Part2 → AI브리핑 → 포트폴리오 → 시스템로그 (채널에는 로그 제외 4개)

*v16 업데이트: Claude Opus 4.6 | 2026-02-09 집 PC — 포트폴리오 추천 통합, 추세 3단계 가중치, Part 2 압축, 테스트 인프라 정리*

---

## Phase 13: adj_score 기반 전환 & 메시지 UX 개선 (v17)

### 13-1. 포트폴리오 랭킹: 괴리율×추세가중치 → adj_score

**문제**: v16의 `abs(fwd_pe_chg) × trend_weight(±20%)` 공식이 괴리율 극단값에 치우침.
- MMS(gap=-21.7, 상향 둔화, adj=12.4)가 LUV(gap=-8.9, 중반 급등, adj=69.2)보다 높은 순위
- ±20% 추세 가중치가 괴리율 범위(-2~-34) 대비 너무 약해서 사실상 무의미

**사용자 인사이트**: "EPS 모멘텀을 보려는 건데 왜 속도로만 보는 거야? 속도랑 방향 둘 다 만족시키는 걸 순위로 해야지"

**해결**: `adj_score`가 이미 속도(score) × 방향(direction) 반영
```
adj_score = score × (1 + clamp(direction/30, -0.3, +0.3))
```
- 새 공식이 필요 없음 — 기존 adj_score 그대로 사용
- 자의적 3단계 추세 가중치(GOOD/NORMAL/BAD) 완전 제거

**결과 비교** (2026-02-09 데이터):
| 순위 | 이전 (괴리율×추세) | 변경 후 (adj_score) |
|------|-------------------|-------------------|
| 1 | SNDK (40%) | SNDK (30%) |
| 2 | MMS (20%) | LUV (20%) |
| 3 | CPRI (15%) | AA (20%) |
| 4 | AA (15%) | FCX (15%) |
| 5 | APH (10%) | FIVE (15%) |

### 13-2. Part 2 정렬: 괴리율 → adj_score

Part 2, AI 분석, 포트폴리오 모두 `fwd_pe_chg` → `adj_score` 내림차순으로 통일.
- Part 2 설명 변경: "EPS 전망치는 좋아졌는데 주가가 아직 못 따라간 종목" → "EPS 모멘텀이 가장 강한 매수 후보"
- 모멘텀 점수 볼드 표시: `괴리 -33.9` → `<b>모멘텀 165.0</b>`
- 읽는법: `괴리 = EPS 대비 주가 미반영도` → `<b>모멘텀</b> = EPS 변화 속도+방향`

### 13-3. 포트폴리오 비중 cap 30%

**문제**: adj_score 비례 배분 시 SNDK(165.0)이 50%로 과집중.
**해결**: 단일 종목 최대 30%, 최소 10%, 5% 단위. 잔여분은 하위 종목부터 배분 (분산 효과).

### 13-4. 메시지 단계별 흐름 [1/4]~[4/4]

4개 메시지가 순차적 단계를 거쳐 최종 포트폴리오에 도달하는 흐름 연출:

```
[1/4] 📈 오늘(MM월DD일) EPS 모멘텀 리포트
  916종목 → Top 30
  👉 다음: 매수 후보 선정 [2/4]

[2/4] 💰 매수 후보 선정
  EPS 모멘텀이 가장 강한 매수 후보
  👉 다음: AI가 위험 신호를 점검해요 [3/4]

[3/4] 🤖 AI 위험 신호 점검
  매수 후보의 위험 신호를 AI가 점검
  👉 다음: 최종 포트폴리오 [4/4]

[4/4] 💼 최종 포트폴리오
  위험 신호 제거 → 최종 5종목
```

### 13-5. UI 세부 개선

- **Part 1 설명 압축**: 5줄 → 2줄 ("미국 916종목 중 애널리스트 EPS 전망치를 가장 많이 올린 기업 순위예요.")
- **Part 2 신호등 읽는법 중복 제거**: Part 1에만 신호등 설명, Part 2에서 제거
- **Part 2 의견 라인 분리**: 변화율·의견 합침(3줄) → 분리(4줄)
- **의견 → 애널리스트 의견**: Part 2, AI 브리핑, 포트폴리오 전체
- **포트폴리오 Gemini 프롬프트**: `**종목명(티커) · 비중 N%**` + 설명 다음줄로 분리
- **AI 브리핑 설명**: "매수 후보의 위험 신호를 AI가 점검했어요." 한 줄로 정리

### 13-6. 디버그 로그

포트폴리오 함수에 상세 로그 추가:
- 각 종목별 ✅/❌ 리스크 플래그 판정 결과
- safe 종목 adj_score 순위 전체 출력
- 선정 5종목 비중 표시

### 13-7. 임시 테스트 워크플로우

`.github/workflows/test-private-only.yml`: 개인봇 전용 전체 테스트.
- TELEGRAM_CHAT_ID 미설정 → 채널 전송 안 함
- 워크플로우 이름에 한글 사용 시 GitHub 인식 안 됨 → ASCII로 변경 (`Test Private Bot Only`)

### 결정 사항 추가

58. **포트폴리오 adj_score 랭킹 (v17)**: 괴리율×추세가중 → adj_score(속도×방향), 자의적 가중치 제거
59. **Part 2 adj_score순 정렬 (v17)**: 괴리율순 → adj_score순, AI분석/포트폴리오도 동일
60. **모멘텀 점수 표시 (v17)**: Part 2에서 괴리 → 모멘텀 점수 볼드 표시
61. **비중 cap 30% (v17)**: 단일 종목 최대 30%, 잔여분 하위부터 배분
62. **단계별 흐름 (v17)**: [1/4]~[4/4] 번호 + 다음 단계 예고 (👉)
63. **Part 1 설명 압축 (v17)**: 5줄 → 2줄
64. **신호등 읽는법 Part 1 전용 (v17)**: Part 2에서 중복 제거
65. **의견 → 애널리스트 의견 (v17)**: 전체 메시지 통일

*v17 업데이트: Claude Opus 4.6 | 2026-02-09 집 PC — adj_score 기반 전환, 단계별 흐름 [1/4]~[4/4], 비중 cap, UI 개선*
