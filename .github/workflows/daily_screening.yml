name: Daily EPS Momentum Screening

on:
  schedule:
    # KST 20:27 = UTC 11:27 (테스트용)
    # 실제 운영시: KST 07:00 = UTC 22:00 (전날) → cron: '0 22 * * *'
    - cron: '27 11 * * *'
  workflow_dispatch:  # 수동 실행 버튼

jobs:
  screening:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install yfinance pandas numpy requests

    - name: Create config with secrets
      run: |
        cat > config.json << 'EOF'
        {
          "python_path": "python",
          "git_enabled": false,
          "telegram_enabled": true,
          "telegram_bot_token": "${{ secrets.TELEGRAM_BOT_TOKEN }}",
          "telegram_chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
          "run_time": "07:00",
          "indices": ["NASDAQ_100", "SP500", "SP400_MidCap"],
          "min_score": 4.0,
          "kill_switch_threshold": -0.01,
          "earnings_blackout_days": 5,
          "action_multipliers": {
            "돌파매수": 1.1,
            "슈퍼모멘텀": 1.1,
            "적극매수": 1.0,
            "저점매수": 1.0,
            "분할매수": 1.0,
            "매수적기": 0.9,
            "RSI관망": 0.75,
            "관망": 0.7,
            "진입금지": 0.3,
            "추세이탈": 0.1
          },
          "exit_strategy": {
            "atr_period": 14,
            "atr_multiplier": 2.0,
            "track_a_ma": 50,
            "track_b_ma": 20
          },
          "threading": {
            "enabled": true,
            "max_workers": 10,
            "batch_size": 50
          },
          "super_momentum": {
            "enabled": true,
            "quality_threshold": 80,
            "rsi_min": 70,
            "rsi_max": 85
          },
          "sector_booster": {
            "enabled": true,
            "min_sector_count": 3,
            "top_n": 10
          },
          "telegram_format": {
            "top_n": 10,
            "watchlist_max": 25
          }
        }
        EOF
        # Replace placeholders with actual secrets
        sed -i "s/\${{ secrets.TELEGRAM_BOT_TOKEN }}/${{ secrets.TELEGRAM_BOT_TOKEN }}/g" config.json
        sed -i "s/\${{ secrets.TELEGRAM_CHAT_ID }}/${{ secrets.TELEGRAM_CHAT_ID }}/g" config.json

    - name: Run screening (Track 1 only)
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from daily_runner import main
        # Track 1만 실행 (스크리닝 + 텔레그램)
        main()
        "
      env:
        PYTHONIOENCODING: utf-8

    - name: Upload screening results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: screening-results-${{ github.run_number }}
        path: |
          eps_data/*.csv
          logs/*.log
        retention-days: 7
